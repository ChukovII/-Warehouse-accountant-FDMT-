{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>üì¶ –£—á–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
            <p class="text-muted">–¢–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Å—Ä–æ–∫–∞–º –≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –ø–æ–∏—Å–∫–æ–º</p>
        </div>
        <div class="col-md-4">
            <!-- –ù–ï–ú–ù–û–ì–û –ò–ó–ú–ï–ù–Ø–ï–ú –§–û–†–ú–£ –ü–û–ò–°–ö–ê: –¥–æ–±–∞–≤–ª—è–µ–º id –∏ —Å–≤—è–∑—ã–≤–∞–µ–º —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
            <form method="get" class="input-group" id="searchForm">
                <input type="text" name="search" class="form-control"
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—É..."
                       value="{{ search_query }}"
                       id="mainSearch">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> –ü–æ–∏—Å–∫
                </button>
            </form>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{% url 'material_list' %}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </a>
            <a href="{% url 'material_create' %}" class="btn btn-success btn-sm">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
            </a>
        </div>
    </div>

    <!-- –ì–õ–ê–í–ù–ê–Ø –§–û–†–ú–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò - –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É -->
    <form method="get" id="filterForm">
        <div class="table-responsive">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <!-- –ê—Ä—Ç–∏–∫—É–ª -->
                        <th width="10%">–ê—Ä—Ç–∏–∫—É–ª</th>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        <th width="25%">
                            –ù–∞–∑–≤–∞–Ω–∏–µ
                            <div class="mt-1">
                                <!-- –≠—Ç–æ—Ç input —Ç–µ–ø–µ—Ä—å –≤ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ä–º–µ filterForm -->
                                <input type="text" name="search"
                                       class="form-control form-control-sm"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..."
                                       value="{{ search_query }}"
                                       id="tableSearch">
                            </div>
                        </th>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <th width="15%">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                            <div class="mt-1">
                                <!-- –î–æ–±–∞–≤–ª—è–µ–º form="filterForm" -->
                                <select name="category" class="form-select form-select-sm" form="filterForm">
                                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}"
                                            {% if selected_category == category.id|stringformat:"i" %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </th>

                        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                        <th width="10%">–ö–æ–ª-–≤–æ</th>

                        <!-- –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
                        <th width="5%">–ï–¥.</th>

                        <!-- –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ -->
                        <th width="15%">
                            –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
                            <div class="mt-1">
                                <!-- –î–æ–±–∞–≤–ª—è–µ–º form="filterForm" -->
                                <select name="expiry" class="form-select form-select-sm" form="filterForm">
                                    <option value="">–í—Å–µ</option>
                                    <option value="expired" {% if selected_expiry == 'expired' %}selected{% endif %}>
                                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
                                    </option>
                                    <option value="expires_soon" {% if selected_expiry == 'expires_soon' %}selected{% endif %}>
                                        –ò—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ (30 –¥–Ω–µ–π)
                                    </option>
                                    <option value="no_expiry" {% if selected_expiry == 'no_expiry' %}selected{% endif %}>
                                        –ë–µ–∑ —Å—Ä–æ–∫–∞
                                    </option>
                                </select>
                            </div>
                        </th>

                        <!-- –ü–æ—Ä–æ–≥ -->
                        <th width="10%">–ü–æ—Ä–æ–≥</th>

                        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                        <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in materials %}
                    <tr class="{{ material.row_class }}">
                        <!-- –ê—Ä—Ç–∏–∫—É–ª -->
                        <td>
                            {% if material.article_number %}
                                <code>{{ material.article_number }}</code>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        <td>
                            <strong>{{ material.name }}</strong>
                            {% if material.current_quantity == 0 %}
                                <span class="badge bg-danger ms-1">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                            {% elif material.current_quantity < material.min_threshold %}
                                <span class="badge bg-warning ms-1">–ú–∞–ª–æ</span>
                            {% endif %}
                        </td>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <td>
                            {% if material.category %}
                                <span class="badge bg-info text-dark">{{ material.category.name }}</span>
                            {% else %}
                                <span class="badge bg-secondary">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                            {% endif %}
                        </td>

                        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                        <td>
                            <strong>{{ material.current_quantity }}</strong>
                        </td>

                        <!-- –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
                        <td>
                            <span class="badge bg-light text-dark">{{ material.unit }}</span>
                        </td>

                        <!-- –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ -->
                        <td>
                            {% if material.expiration_date %}
                                {{ material.expiration_date|date:"d.m.Y" }}
                                {% if material.expiry_status == 'expired' %}
                                    <span class="badge bg-danger d-block mt-1">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</span>
                                {% elif material.expiry_status == 'soon' %}
                                    <span class="badge bg-warning d-block mt-1">–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </td>

                        <!-- –ü–æ—Ä–æ–≥ -->
                        <td>
                            <span class="badge bg-secondary">{{ material.min_threshold }}</span>
                        </td>

<td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'log_operation' material.pk %}"
                                   class="btn btn-sm btn-primary" title="–û–ø–µ—Ä–∞—Ü–∏—è (–ü—Ä–∏—Ö–æ–¥/–†–∞—Å—Ö–æ–¥)">
                                    <i class="bi bi-journal-check"></i>
                                </a>
                                <a href="{% url 'material_history' material.pk %}"
                                   class="btn btn-sm btn-outline-info" title="–ò—Å—Ç–æ—Ä–∏—è">
                                    <i class="bi bi-clock-history"></i>
                                </a>
                                <a href="{% url 'material_update' material.pk %}"
                                   class="btn btn-sm btn-outline-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'material_delete' material.pk %}"
                                   class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                <p class="mt-2">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                {% if search_query or selected_category or selected_expiry %}
                                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                                    <a href="{% url 'material_list' %}" class="btn btn-sm btn-outline-primary">
                                        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                    </a>
                                {% else %}
                                    <a href="{% url 'material_create' %}" class="btn btn-sm btn-primary">
                                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
                                    </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form> <!-- –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    {% if materials %}
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col">
                            <small class="text-muted">–í—Å–µ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:</small>
                            <h5 class="mb-0">{{ total_count|default:materials.count }}</h5>
                        </div>
                        <div class="col">
                            <small class="text-muted">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫:</small>
                            <h5 class="mb-0 text-danger">{{ critical_count|default:0 }}</h5>
                        </div>
                        <div class="col">
                            <small class="text-muted">–ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞:</small>
                            <h5 class="mb-0 text-warning">{{ below_threshold_count|default:0 }}</h5>
                        </div>
                        <div class="col">
                            <small class="text-muted">–° –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º:</small>
                            <h5 class="mb-0 text-warning">{{ soon_expiry_count|default:0 }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const searchForm = document.getElementById('searchForm');
    const mainSearch = document.getElementById('mainSearch');
    const tableSearch = document.getElementById('tableSearch');

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–≤—É—Ö –ø–æ–ª–µ–π –ø–æ–∏—Å–∫–∞
    function syncSearchFields() {
        mainSearch.value = tableSearch.value;
    }

    mainSearch.addEventListener('input', syncSearchFields);
    tableSearch.addEventListener('input', syncSearchFields);

    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ select –≤ —Ç–∞–±–ª–∏—Ü–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é —Ñ–æ—Ä–º—É
    document.querySelectorAll('select').forEach(function(select) {
        select.addEventListener('change', function() {
            // –ö–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –≤ –≥–ª–∞–≤–Ω—É—é —Ñ–æ—Ä–º—É
            const searchInput = document.createElement('input');
            searchInput.type = 'hidden';
            searchInput.name = 'search';
            searchInput.value = tableSearch.value;
            filterForm.appendChild(searchInput);

            filterForm.submit();
        });
    });

    // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –≤ –ª—é–±–æ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    [mainSearch, tableSearch].forEach(function(input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();

                if (input === mainSearch) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø–æ–∏—Å–∫–∞
                    searchForm.submit();
                } else {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                    filterForm.submit();
                }
            }
        });
    });

    // –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∫–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–µ –ø–æ–ª–µ
    searchForm.addEventListener('submit', function(e) {
        tableSearch.value = mainSearch.value;
    });
});
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
.table th {
    position: relative;
}
.table th .form-control-sm,
.table th .form-select-sm {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
}
.table-danger {
    background-color: rgba(220, 53, 69, 0.1);
}
.table-warning {
    background-color: rgba(255, 193, 7, 0.1);
}
.table-light {
    background-color: #f8f9fa;
}
</style>
{% endblock %}