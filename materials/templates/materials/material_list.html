{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>üì¶ –£—á–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
            <p class="text-muted">–¢–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Å—Ä–æ–∫–∞–º –≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –ø–æ–∏—Å–∫–æ–º</p>
        </div>
        <div class="col-md-4">
            <form method="get" class="input-group" id="searchForm">
                <input type="text" name="search" class="form-control"
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—É..."
                       value="{{ search_query }}"
                       id="mainSearch">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> –ü–æ–∏—Å–∫
                </button>
            </form>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <a href="{% url 'material_list' %}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </a>
            <a href="{% url 'material_create' %}" class="btn btn-success btn-sm">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
            </a>
            <a href="{% url 'analytics_report' %}" class="btn btn-outline-info btn-sm ms-2">
                <i class="bi bi-graph-up-arrow"></i> –û—Ç—á–µ—Ç—ã –∏ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            </a>
        </div>
    </div>

    <form method="get" id="filterForm">
        <div class="table-responsive">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th width="10%">–ê—Ä—Ç–∏–∫—É–ª</th>
                        <th width="25%">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th width="15%">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                            <div class="mt-1">
                                <select name="category" class="form-select form-select-sm" form="filterForm">
                                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}"
                                            {% if selected_category == category.id|stringformat:"i" %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </th>
                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                        <th width="5%">–ï–¥.</th>
                        <th width="15%">
                            –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
                            <div class="mt-1">
                                <select name="expiry" class="form-select form-select-sm" form="filterForm">
                                    <option value="">–í—Å–µ</option>
                                    <option value="expired" {% if selected_expiry == 'expired' %}selected{% endif %}>
                                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
                                    </option>
                                    <option value="expires_soon" {% if selected_expiry == 'expires_soon' %}selected{% endif %}>
                                        –ò—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ (30 –¥–Ω–µ–π)
                                    </option>
                                    <option value="no_expiry" {% if selected_expiry == 'no_expiry' %}selected{% endif %}>
                                        –ë–µ–∑ —Å—Ä–æ–∫–∞
                                    </option>
                                </select>
                            </div>
                        </th>
                        <th width="10%">–ü–æ—Ä–æ–≥</th>
                        <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in materials %}
                    <tr class="{{ material.row_class }}"
                        {% if material.row_class == 'table-warning' %}style="background-color: #FFEE90 !important;"{% endif %}>

                        <td>
                            {% if material.article_number %}
                                <code>{{ material.article_number }}</code>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>

                        <td>
                            <strong>{{ material.name }}</strong>
                            {% if material.current_quantity == 0 %}
                                <span class="badge bg-danger ms-1">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                            {% elif material.current_quantity < material.min_threshold %}
                                <span class="badge bg-warning ms-1">–ú–∞–ª–æ</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if material.category %}
                                <span class="badge bg-info text-dark">{{ material.category.name }}</span>
                            {% else %}
                                <span class="badge bg-secondary">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                            {% endif %}
                        </td>

                        <td>
                            <strong>{{ material.current_quantity }}</strong>
                        </td>

                        <td>
                            <span class="badge bg-light text-dark">{{ material.unit }}</span>
                        </td>

                        <td>
                            {% if material.expiration_date %}
                                {{ material.expiration_date|date:"d.m.Y" }}
                                {% if material.expiry_status == 'expired' %}
                                    <span class="badge bg-danger d-block mt-1">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</span>
                                {% elif material.expiry_status == 'soon' %}
                                    <span class="badge bg-warning d-block mt-1">–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </td>

                        <td>
                            <span class="badge bg-secondary">{{ material.min_threshold }}</span>
                        </td>

                        <td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'log_operation' material.pk %}"
                                   class="btn btn-sm btn-outline-primary" title="–û–ø–µ—Ä–∞—Ü–∏—è (–ü—Ä–∏—Ö–æ–¥/–†–∞—Å—Ö–æ–¥)">
                                    <i class="bi bi-journal-check"></i> –û–ø–µ—Ä–∞—Ü–∏–∏
                                </a>
                                {# –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –î–õ–Ø –ü–†–û–ì–ù–û–ó–ê –ò–ò #}
                                <a href="{% url 'material_forecast' pk=material.pk %}"
                                   class="btn btn-sm btn-outline-success" title="–ü—Ä–æ–≥–Ω–æ–∑ –ò–ò">
                                     <i class="fas fa-magic"></i> –ò–ò –ø—Ä–æ–≥–Ω–æ–∑
                                </a>
                                <a href="{% url 'material_history' material.pk %}"
                                   class="btn btn-sm btn-outline-info" title="–ò—Å—Ç–æ—Ä–∏—è">
                                    <i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è
                                </a>
                                <a href="{% url 'material_update' material.pk %}"
                                   class="btn btn-sm btn-outline-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                                </a>
                                <a href="{% url 'material_delete' material.pk %}"
                                   class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                <p class="mt-2">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                {% if search_query or selected_category or selected_expiry %}
                                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                                    <a href="{% url 'material_list' %}" class="btn btn-sm btn-outline-primary">
                                        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                    </a>
                                {% else %}
                                    <a href="{% url 'material_create' %}" class="btn btn-sm btn-primary">
                                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
                                    </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    {% if materials %}
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col">
                            <small class="text-muted">–í—Å–µ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:</small>
                            <h5 class="mb-0">{{ total_count|default:materials.count }}</h5>
                        </div>
                        <div class="col">
                            <small class="text-muted">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫:</small>
                            <h5 class="mb-0 text-danger">{{ critical_count|default:0 }}</h5>
                        </div>
                        <div class="col">
                            <small class="text-muted">–ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞:</small>
                            <h5 class="mb-0 text-warning">{{ below_threshold_count|default:0 }}</h5>
                        </div>
                        <div class="col">
                            <small class="text-muted">–° –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º:</small>
                            <h5 class="mb-0 text-warning">{{ soon_expiry_count|default:0 }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§–æ—Ä–º–∞ filterForm –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    const filterSelects = document.querySelectorAll('#filterForm select');

    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            // –ö–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∏–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ –ø–æ–ª—è
            const mainSearch = document.querySelector('input[name="search"]');
            if (mainSearch && mainSearch.value) {
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
                const hiddenSearch = document.createElement('input');
                hiddenSearch.type = 'hidden';
                hiddenSearch.name = 'search';
                hiddenSearch.value = mainSearch.value;
                document.getElementById('filterForm').appendChild(hiddenSearch);
            }

            document.getElementById('filterForm').submit();
        });
    });
});
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
.table th {
    position: relative;
}
.table th .form-control-sm,
.table th .form-select-sm {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
}
.table-danger {
    background-color: rgba(220, 53, 69, 0.1);
}
.table-light {
    background-color: #f8f9fa;
}
</style>
{% endblock %}